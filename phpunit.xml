<?xml version="1.0" encoding="UTF-8"?>
<phpunit xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="https://schema.phpunit.de/10.0/phpunit.xsd"
         bootstrap="vendor/autoload.php"
         colors="true"
         cacheResult="true"
         cacheDirectory="./var/cache/phpunit"
         executionOrder="depends,defects"
         failOnRisky="true"
         failOnWarning="true"
         stopOnFailure="false"
         beStrictAboutChangesToGlobalState="true"
         beStrictAboutOutputDuringTests="true"
         beStrictAboutResourceUsageDuringSmallTests="true"
         beStrictAboutTestsThatDoNotTestAnything="true"
         beStrictAboutCoversAnnotation="true"
         beStrictAboutCoverageMetadata="true"
         enforceTimeLimit="true">

    <!-- Test Suites Configuration -->
    <testsuites>
        <testsuite name="All Tests">
            <directory>tests</directory>
        </testsuite>

        <testsuite name="Unit Tests">
            <directory>tests/Unit</directory>
        </testsuite>

        <testsuite name="Integration Tests">
            <directory>tests/Integration</directory>
        </testsuite>

        <testsuite name="Feature Tests">
            <directory>tests/Feature</directory>
        </testsuite>

        <!-- Module-specific test suites -->
        <testsuite name="Orders Module">
            <directory>tests/Unit/Orders</directory>
            <directory>tests/Integration/OrdersIntegrationTest.php</directory>
        </testsuite>

        <testsuite name="Subscriptions Module">
            <directory>tests/Unit/Subscriptions</directory>
            <directory>tests/Integration/SubscriptionsIntegrationTest.php</directory>
        </testsuite>

        <testsuite name="Tracking Module">
            <directory>tests/Unit/Tracking</directory>
            <directory>tests/Integration/TrackingIntegrationTest.php</directory>
        </testsuite>

        <testsuite name="UserManagement Module">
            <directory>tests/Unit/UserManagement</directory>
            <directory>tests/Integration/UserManagementIntegrationTest.php</directory>
        </testsuite>

        <testsuite name="Notifications Module">
            <directory>tests/Unit/Notifications</directory>
            <directory>tests/Integration/NotificationsIntegrationTest.php</directory>
        </testsuite>

        <!-- Core functionality tests -->
        <testsuite name="Core Tests">
            <directory>tests/Unit/Core</directory>
        </testsuite>

        <!-- Laravel Integration Tests -->
        <testsuite name="Laravel Integration">
            <directory>tests/Unit/Laravel</directory>
            <directory>tests/Feature/LaravelIntegrationTest.php</directory>
        </testsuite>
    </testsuites>

    <!-- Source Code for Coverage -->
    <source>
        <include>
            <directory>src</directory>
        </include>
        <exclude>
            <directory>src/Laravel/Commands</directory>
            <file>src/Laravel/ClubifyCheckoutServiceProvider.php</file>
        </exclude>
    </source>

    <!-- Code Coverage Configuration -->
    <coverage>
        <report>
            <html outputDirectory="./var/coverage/html" lowUpperBound="50" highLowerBound="90"/>
            <clover outputFile="./var/coverage/clover.xml"/>
            <crap4j outputFile="./var/coverage/crap4j.xml" threshold="50"/>
            <text outputFile="./var/coverage/coverage.txt" showUncoveredFiles="true" showOnlySummary="false"/>
            <xml outputDirectory="./var/coverage/xml"/>
        </report>
    </coverage>

    <!-- Logging Configuration -->
    <logging>
        <junit outputFile="./var/logs/phpunit/junit.xml"/>
        <teamcity outputFile="./var/logs/phpunit/teamcity.txt"/>
        <testdoxHtml outputFile="./var/logs/phpunit/testdox.html"/>
        <testdoxText outputFile="./var/logs/phpunit/testdox.txt"/>
    </logging>

    <!-- PHP Configuration -->
    <php>
        <!-- Application Environment -->
        <env name="APP_ENV" value="testing"/>
        <env name="APP_DEBUG" value="true"/>

        <!-- SDK Configuration -->
        <env name="CLUBIFY_API_URL" value="http://localhost:8080"/>
        <env name="CLUBIFY_TENANT_ID" value="test-tenant"/>
        <env name="CLUBIFY_API_KEY" value="test-api-key"/>
        <env name="CLUBIFY_SECRET_KEY" value="test-secret-key"/>

        <!-- Testing Configuration -->
        <env name="CACHE_DRIVER" value="array"/>
        <env name="SESSION_DRIVER" value="array"/>
        <env name="QUEUE_DRIVER" value="sync"/>
        <env name="MAIL_DRIVER" value="array"/>

        <!-- Database Testing -->
        <env name="DB_CONNECTION" value="sqlite"/>
        <env name="DB_DATABASE" value=":memory:"/>

        <!-- Disable external services in tests -->
        <env name="CLUBIFY_DISABLE_WEBHOOKS" value="true"/>
        <env name="CLUBIFY_MOCK_HTTP_CLIENT" value="true"/>

        <!-- Test timeouts -->
        <env name="PHPUNIT_TIMEOUT" value="10"/>
        <env name="PHPUNIT_HTTP_TIMEOUT" value="5"/>

        <!-- Memory and time limits -->
        <ini name="memory_limit" value="512M"/>
        <ini name="max_execution_time" value="60"/>

        <!-- Error reporting -->
        <ini name="error_reporting" value="E_ALL"/>
        <ini name="display_errors" value="1"/>
        <ini name="display_startup_errors" value="1"/>

        <!-- Assertions -->
        <ini name="assert.active" value="1"/>
        <ini name="assert.exception" value="1"/>
        <ini name="zend.assertions" value="1"/>
    </php>

    <!-- Extensions Configuration -->
    <extensions>
        <!-- Mockery Extension for clean teardown -->
        <extension class="Mockery\Adapter\Phpunit\MockeryExtension"/>
    </extensions>

    <!-- Global Test Settings -->
    <groups>
        <exclude>
            <group>slow</group>
            <group>external</group>
            <group>integration</group>
        </exclude>
    </groups>

    <!-- Test Listeners -->
    <listeners>
        <!-- Custom test result printer for better output -->
    </listeners>
</phpunit>